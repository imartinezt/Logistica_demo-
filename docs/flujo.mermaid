flowchart TD
    A[ğŸš€ REQUEST FEE<br/>SKU + Cantidad + CP + Fecha] --> B[ğŸ“¦ Validar Producto]
    B --> C{Â¿Producto existe?}
    C -->|âŒ| ERR1[âŒ Error: Producto no encontrado]
    C -->|âœ…| D[ğŸ—ºï¸ Analizar CÃ³digo Postal]

    D --> E[ğŸ“ Buscar Tiendas Cercanas]
    E --> F[ğŸª Buscar Tiendas Autorizadas]
    F --> G[ğŸ“Š AnÃ¡lisis de Stock]

    G --> H{Â¿Stock disponible?}
    H -->|âŒ| ERR2[âŒ Error: Sin stock]
    H -->|âœ…| I[ğŸ¯ AsignaciÃ³n Inteligente]

    I --> J{Â¿Stock local suficiente?}
    J -->|âœ… Completo| K[ğŸ“¦ CASO SIMPLE]
    J -->|âš ï¸ Parcial| L[ğŸ”„ CASO SPLIT]
    J -->|âŒ Solo nacional| M[ğŸŒ CASO NACIONAL]

    %% === CASO SIMPLE ===
    K --> K1[ğŸ’š Stock 100% local]
    K1 --> K2[ğŸ•’ Evaluar Horario]
    K2 --> K3{Â¿EXPRESS factible?}
    K3 -->|âœ…| K4[âš¡ EXPRESS<br/>1-2 dÃ­as]
    K3 -->|âŒ| K5[ğŸ“… STANDARD<br/>2-3 dÃ­as]
    K4 --> SINGLE[ğŸ“‹ SINGLE DELIVERY]
    K5 --> SINGLE

    %% === CASO SPLIT (EL MÃS COMPLEJO) ===
    L --> L1[ğŸ”€ Stock distribuido en mÃºltiples tiendas]
    L1 --> L2[ğŸ§  AnÃ¡lisis Multi-Ruta]
    L2 --> L3{Â¿Hay tiendas locales?}
    L3 -->|âœ…| L4[ğŸ  OPCIÃ“N LOCAL<br/>Tiendas cercanas]
    L3 -->|âŒ| L5[âŒ Sin local]

    L4 --> L6[ğŸ­ OPCIÃ“N CONSOLIDADA<br/>Hub intermedio]
    L5 --> L6
    L6 --> L7[ğŸŒ OPCIÃ“N NACIONAL<br/>VÃ­a CEDIS]

    L7 --> MULTI[ğŸ“‹ MULTIPLE DELIVERY<br/>2-3 opciones]

    %% === CASO NACIONAL ===
    M --> M1[ğŸŒ Solo stock nacional disponible]
    M1 --> M2[ğŸ­ Evaluar CEDIS]
    M2 --> M3{Â¿Distancia > 200km?}
    M3 -->|âœ…| M4[ğŸ“… PROGRAMADA<br/>4-5 dÃ­as]
    M3 -->|âŒ| M5[ğŸ“… STANDARD<br/>2-3 dÃ­as]
    M4 --> SINGLE2[ğŸ“‹ SINGLE DELIVERY]
    M5 --> SINGLE2

    %% === EVALUACIÃ“N DE HORARIOS ===
    HORARIO[ğŸ•’ EVALUACIÃ“N HORARIOS]
    HORARIO --> H1{Â¿Hora compra?}
    H1 -->|06:00-20:00| H2[â° Horario operativo]
    H1 -->|20:01-23:59| H3[ğŸŒ™ Nocturno]
    H1 -->|00:00-05:59| H4[ğŸŒ„ Madrugada]

    H2 --> H5{Â¿Stock local?}
    H3 --> H6[âš¡ EXPRESS +1 dÃ­a]
    H4 --> H7[âš¡ EXPRESS +1 dÃ­a]

    H5 -->|âœ…| H8[âš¡ EXPRESS mismo dÃ­a]
    H5 -->|âŒ| H9[ğŸ“… STANDARD]

    %% === FACTORES EXTERNOS ===
    FACT[ğŸŒ¦ï¸ FACTORES EXTERNOS]
    FACT --> F1[ğŸ›¡ï¸ Zona Seguridad]
    FACT --> F2[ğŸŒ¤ï¸ Clima]
    FACT --> F3[ğŸš— TrÃ¡fico]
    FACT --> F4[ğŸ“ˆ Demanda]

    F1 --> FZ{Â¿Zona?}
    FZ -->|ğŸŸ¢ Verde| FZ1[+0 dÃ­as]
    FZ -->|ğŸŸ¡ Amarilla| FZ2[+0 dÃ­as]
    FZ -->|ğŸ”´ Roja| FZ3[+1-2 dÃ­as<br/>Solo PROGRAMADA]

    %% === RESPUESTAS FINALES ===
    SINGLE --> R1[ğŸ“¦ RESPUESTA SIMPLE]
    SINGLE2 --> R1
    MULTI --> R2[ğŸ“¦ RESPUESTA MÃšLTIPLE]

    R1 --> R1A[ğŸ¯ 1 opciÃ³n de entrega<br/>tipo_respuesta: single_delivery_date]
    R2 --> R2A[ğŸ¯ 2-3 opciones de entrega<br/>tipo_respuesta: multiple_delivery_dates]

    R2A --> R2B[ğŸ  OpciÃ³n Local: Stock cercano]
    R2A --> R2C[ğŸ­ OpciÃ³n Consolidada: Hub]
    R2A --> R2D[ğŸŒ OpciÃ³n Nacional: CEDIS]

    %% === EJEMPLOS REALES ===
    EJ[ğŸ“‹ EJEMPLOS REALES]
    EJ --> EJ1[ğŸ¯ SINALOA 82000<br/>âŒ Sin stock local<br/>âœ… PROGRAMADA vÃ­a CEDIS<br/>ğŸ­ 2 tiendas origen]

    EJ --> EJ2[ğŸ¯ CDMX 06700<br/>âš ï¸ Stock parcial local<br/>âœ… MÃšLTIPLE: 3 opciones<br/>ğŸ”„ ConsolidaciÃ³n + Nacional]

    EJ --> EJ3[ğŸ¯ SANTA FE 05050<br/>âœ… Stock local completo<br/>âœ… EXPRESS/STANDARD<br/>ğŸ’š Entrega directa]

    %% === ESTILOS ===
    classDef simple fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef complex fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef success fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef decision fill:#f3e5f5,stroke:#4a148c,stroke-width:2px

    class K,K1,K2,K4,K5 simple
    class L,L1,L2,L6,L7,M,M1,M2 complex
    class ERR1,ERR2 error
    class SINGLE,SINGLE2,MULTI,R1A,R2A success
    class C,H,J,L3,M3,H1,H5,FZ decision