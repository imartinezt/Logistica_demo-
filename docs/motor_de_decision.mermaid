flowchart TD
    ROOT[ğŸš€ REQUEST FEE<br/>quantity=51, cp=06700]

    ROOT --> CHECK_STOCK[ğŸ“¦ Verificar Stock Total]
    CHECK_STOCK --> STOCK_OK{Â¿Stock disponible â‰¥ cantidad?}

    STOCK_OK -->|âŒ| NO_STOCK[âŒ Error: Stock insuficiente]
    STOCK_OK -->|âœ…| ANALYZE_LOCAL[ğŸ  Analizar Stock Local]

    ANALYZE_LOCAL --> LOCAL_CHECK{ğŸ“Š Stock local vs requerido}

    %% ========== RAMA 1: STOCK LOCAL SUFICIENTE ==========
    LOCAL_CHECK -->|Stock local â‰¥ cantidad<br/>ejemplo: local=34, need=51| SUFFICIENT[âœ… STOCK LOCAL SUFICIENTE]

    SUFFICIENT --> SIMPLE_FACTORS[ğŸ¯ Evaluar factores simples]
    SIMPLE_FACTORS --> SIMPLE_DECISION[ğŸ” Una sola ruta Ã³ptima]
    SIMPLE_DECISION --> SINGLE_RESULT[ğŸ“¦ SINGLE DELIVERY<br/>tipo_respuesta: single_delivery_date<br/>resultado_final: â€¦]

    %% ========== RAMA 2: STOCK LOCAL INSUFICIENTE ==========
    LOCAL_CHECK -->|Stock local < cantidad<br/>ejemplo: local=16, need=51| INSUFFICIENT[âš ï¸ STOCK LOCAL INSUFICIENTE]

    INSUFFICIENT --> NEED_NATIONAL[ğŸŒ Buscar stock nacional]
    NEED_NATIONAL --> NATIONAL_CHECK{Â¿Stock nacional suficiente?}

    NATIONAL_CHECK -->|âŒ| NO_STOCK
    NATIONAL_CHECK -->|âœ…| MULTI_SCENARIO[ğŸ”„ ESCENARIO MÃšLTIPLE]

    MULTI_SCENARIO --> EVALUATE_OPTIONS[ğŸ§  Evaluar todas las opciones posibles]

    %% ========== GENERACIÃ“N DE OPCIONES MÃšLTIPLES ==========
    EVALUATE_OPTIONS --> OPTION_A[ğŸ  OPCIÃ“N LOCAL<br/>Usar solo stock cercano]
    EVALUATE_OPTIONS --> OPTION_B[ğŸ­ OPCIÃ“N CONSOLIDADA<br/>Combinar mÃºltiples tiendas]
    EVALUATE_OPTIONS --> OPTION_C[ğŸŒ OPCIÃ“N NACIONAL<br/>Usar CEDIS remotos]

    OPTION_A --> CALC_A[ğŸ“Š Calcular factibilidad<br/>cantidad_cubierta: 34/51<br/>costo: bajo<br/>tiempo: rÃ¡pido]
    OPTION_B --> CALC_B[ğŸ“Š Calcular factibilidad<br/>cantidad_cubierta: 51/51<br/>costo: medio<br/>tiempo: medio]
    OPTION_C --> CALC_C[ğŸ“Š Calcular factibilidad<br/>cantidad_cubierta: 17/51<br/>costo: alto<br/>tiempo: lento]

    CALC_A --> MULTIPLE_RESULT[ğŸ“¦ MULTIPLE DELIVERY<br/>tipo_respuesta: multiple_delivery_dates<br/>total_options: 3]
    CALC_B --> MULTIPLE_RESULT
    CALC_C --> MULTIPLE_RESULT

    %% ========== CASOS ESPECIALES ==========
    NATIONAL_CHECK -->|Solo 1 opciÃ³n viable| FORCED_SINGLE[ğŸ¯ Una sola opciÃ³n nacional]
    FORCED_SINGLE --> SINGLE_NATIONAL[ğŸ“¦ SINGLE DELIVERY<br/>Tipo: PROGRAMADA]

    %% ========== EJEMPLOS REALES ==========
    EXAMPLES[ğŸ“‹ EJEMPLOS DE TUS TESTS]

    EXAMPLES --> EX_SIMPLE[ğŸŸ¢ SIMPLE: CP 05050<br/>quantity=1, stock_local=34<br/>âœ… Suficiente â†’ SINGLE]
    EX_SIMPLE --> EX_SIMPLE_R[ğŸ“¦ EXPRESS/STANDARD<br/>1 opciÃ³n Ãºnica]

    EXAMPLES --> EX_MULTI[ğŸŸ¡ MÃšLTIPLE: CP 06700<br/>quantity=51, stock_local=16<br/>âš ï¸ Insuficiente â†’ MULTIPLE]
    EX_MULTI --> EX_MULTI_R[ğŸ“¦ 3 opciones:<br/>LOCAL + CONSOLIDADA + NACIONAL]

    EXAMPLES --> EX_NACIONAL[ğŸ”´ NACIONAL: CP 82000<br/>quantity=51, stock_local=0<br/>âŒ Sin local â†’ SINGLE NACIONAL]
    EX_NACIONAL --> EX_NACIONAL_R[ğŸ“¦ PROGRAMADA<br/>VÃ­a CEDIS Ãºnica]

    %% ========== ALGORITMO DE DECISIÃ“N ==========
    ALGORITHM[ğŸ¤– ALGORITMO DE DECISIÃ“N]
    ALGORITHM --> ALG_1[1. stock_local â‰¥ quantity?]
    ALG_1 -->|SÃ| ALG_SINGLE[â†’ SINGLE DELIVERY]
    ALG_1 -->|NO| ALG_2[2. stock_nacional â‰¥ quantity?]
    ALG_2 -->|NO| ALG_ERROR[â†’ ERROR]
    ALG_2 -->|SÃ| ALG_3[3. Â¿MÃºltiples rutas viables?]
    ALG_3 -->|SÃ| ALG_MULTI[â†’ MULTIPLE DELIVERY]
    ALG_3 -->|NO| ALG_FORCE[â†’ SINGLE DELIVERY forzado]

    %% ========== CONDICIONES PARA MULTIPLE ==========
    CONDITIONS[ğŸ“‹ CONDICIONES PARA MULTIPLE]
    CONDITIONS --> C1[âœ“ Stock insuficiente localmente]
    CONDITIONS --> C2[âœ“ MÃºltiples tiendas con stock]
    CONDITIONS --> C3[âœ“ Diferentes rutas viables]
    CONDITIONS --> C4[âœ“ Costos/tiempos variables]

    %% ========== FACTORES DE EVALUACIÃ“N ==========
    FACTORS[âš–ï¸ FACTORES DE EVALUACIÃ“N]
    FACTORS --> WEIGHT_TIME[â° Tiempo: 35%]
    FACTORS --> WEIGHT_COST[ğŸ’° Costo: 35%]
    FACTORS --> WEIGHT_STOCK[ğŸ“¦ Stock: 20%]
    FACTORS --> WEIGHT_DIST[ğŸ“ Distancia: 10%]

    %% ========== TIPOS DE RUTA POR CASO ==========
    ROUTE_TYPES[ğŸ›£ï¸ TIPOS DE RUTA]
    ROUTE_TYPES --> RT_DIRECT[ğŸ  DIRECTA<br/>Tienda â†’ Cliente<br/>Stock local suficiente]
    ROUTE_TYPES --> RT_HUB[ğŸ­ HUB<br/>Tiendas â†’ Hub â†’ Cliente<br/>ConsolidaciÃ³n]
    ROUTE_TYPES --> RT_CEDIS[ğŸŒ CEDIS<br/>Tienda â†’ CEDIS â†’ Cliente<br/>Larga distancia]

    %% ========== ESTILOS ==========
    classDef sufficient fill:#e8f5e8,stroke:#4caf50,stroke-width:3px
    classDef insufficient fill:#fff3e0,stroke:#ff9800,stroke-width:3px
    classDef error fill:#ffebee,stroke:#f44336,stroke-width:3px
    classDef single fill:#e3f2fd,stroke:#2196f3,stroke-width:3px
    classDef multiple fill:#f3e5f5,stroke:#9c27b0,stroke-width:3px
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px
    classDef example fill:#f1f8e9,stroke:#689f38,stroke-width:2px

    class SUFFICIENT,CALC_A sufficient
    class INSUFFICIENT,MULTI_SCENARIO,EVALUATE_OPTIONS insufficient
    class NO_STOCK error
    class SINGLE_RESULT,SINGLE_NATIONAL,ALG_SINGLE single
    class MULTIPLE_RESULT,ALG_MULTI multiple
    class LOCAL_CHECK,STOCK_OK,NATIONAL_CHECK,ALG_3 decision
    class EX_SIMPLE,EX_MULTI,EX_NACIONAL,EXAMPLES example
